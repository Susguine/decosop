name: Deploy DecoSOP

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install .NET SDK
        run: |
          $installDir = "$env:RUNNER_TOOL_CACHE\dotnet"
          Invoke-WebRequest -Uri https://dot.net/v1/dotnet-install.ps1 -OutFile dotnet-install.ps1
          .\dotnet-install.ps1 -Channel 10.0 -InstallDir $installDir
          echo "$installDir" | Out-File -Append -FilePath $env:GITHUB_PATH
          echo "DOTNET_ROOT=$installDir" | Out-File -Append -FilePath $env:GITHUB_ENV
        shell: powershell

      - name: Publish app
        run: dotnet publish -c Release -r win-x64 --self-contained -o ./publish

      - name: Stop service
        run: Stop-Service -Name "DecoSOP" -ErrorAction SilentlyContinue
        shell: powershell

      - name: Wait for service to stop
        run: Start-Sleep -Seconds 3
        shell: powershell

      - name: Deploy files
        run: |
          $source = "./publish/*"
          $dest = "C:\DecoSOP"
          if (!(Test-Path $dest)) { New-Item -ItemType Directory -Path $dest }
          Copy-Item -Path $source -Destination $dest -Recurse -Force -Exclude "decosop.db"
        shell: powershell

      - name: Ensure firewall rule
        run: |
          $rule = netsh advfirewall firewall show rule name="DecoSOP" 2>$null
          if (-not ($rule -match "DecoSOP")) {
            netsh advfirewall firewall add rule name="DecoSOP" dir=in action=allow protocol=TCP localport=5098
          }
        shell: powershell

      - name: Start service
        run: |
          $svc = Get-Service -Name "DecoSOP" -ErrorAction SilentlyContinue
          if (-not $svc) {
            sc.exe create DecoSOP binPath="C:\DecoSOP\DecoSOP.exe" start=auto
          }
          Start-Service -Name "DecoSOP"
        shell: powershell
