@page "/category/{Id:int}"
@using DecoSOP.Services
@using DecoSOP.Models
@inject SopService SopService
@inject NavigationManager Nav
@rendermode InteractiveServer

<PageTitle>@(category?.Name ?? "Category") - DecoSOP</PageTitle>

@if (category is null)
{
    <p>Loading...</p>
}
else
{
    <div class="home-container">
        <nav class="breadcrumb-nav" aria-label="breadcrumb">
            <a href="/">Home</a>
            @foreach (var crumb in breadcrumbs)
            {
                <span> / </span>
                @if (crumb.Id == category.Id)
                {
                    <span>@crumb.Name</span>
                }
                else
                {
                    <a href="category/@crumb.Id">@crumb.Name</a>
                }
            }
        </nav>

        <h1>@category.Name</h1>

        @if (category.Children.Any() || category.Documents.Any())
        {
            <div class="category-grid">
                @foreach (var child in category.Children.OrderBy(c => c.Name))
                {
                    var childTotal = GetTotalDocCount(child);
                    <div class="category-card">
                        <h3>
                            <a href="category/@child.Id" class="category-heading-link">@child.Name</a>
                            <span class="text-muted small">(@childTotal)</span>
                            <button class="btn-star @(child.IsFavorited ? "starred" : "")"
                                    title="@(child.IsFavorited ? "Remove from favorites" : "Add to favorites")"
                                    @onclick="() => ToggleCategoryFavorite(child)">
                                @(child.IsFavorited ? "\u2605" : "\u2606")
                            </button>
                        </h3>
                        @if (child.Children.Any())
                        {
                            <p class="text-muted small" style="margin:0 0 0.25rem 0;">@child.Children.Count subfolder@(child.Children.Count != 1 ? "s" : "")</p>
                        }
                        @if (child.Documents.Any())
                        {
                            <ul class="card-doc-list">
                                @foreach (var doc in child.Documents.OrderBy(d => d.SortOrder))
                                {
                                    <li><a href="sop/@doc.Id">@doc.Title</a></li>
                                }
                            </ul>
                        }
                    </div>
                }

                @foreach (var doc in category.Documents.OrderBy(d => d.SortOrder))
                {
                    <div class="category-card category-card-doc">
                        <h3>
                            <a href="sop/@doc.Id" class="category-heading-link">@doc.Title</a>
                            <button class="btn-star @(doc.IsFavorited ? "starred" : "")"
                                    title="@(doc.IsFavorited ? "Remove from favorites" : "Add to favorites")"
                                    @onclick="() => ToggleDocumentFavorite(doc)">
                                @(doc.IsFavorited ? "\u2605" : "\u2606")
                            </button>
                        </h3>
                    </div>
                }
            </div>
        }
        else
        {
            <p class="text-muted">This folder is empty.</p>
        }
    </div>
}

@code {
    [Parameter] public int Id { get; set; }

    private Category? category;
    private List<(int Id, string Name)> breadcrumbs = [];

    protected override async Task OnParametersSetAsync()
    {
        category = await SopService.GetCategoryWithChildrenAsync(Id);
        if (category is not null)
            breadcrumbs = await SopService.GetCategoryBreadcrumbsAsync(Id);
    }

    private async Task ToggleCategoryFavorite(Category cat)
    {
        cat.IsFavorited = await SopService.ToggleCategoryFavoriteAsync(cat.Id);
    }

    private async Task ToggleDocumentFavorite(SopDocument doc)
    {
        doc.IsFavorited = await SopService.ToggleDocumentFavoriteAsync(doc.Id);
    }

    private int GetTotalDocCount(Category cat)
    {
        int count = cat.Documents.Count;
        foreach (var child in cat.Children)
            count += GetTotalDocCount(child);
        return count;
    }
}
