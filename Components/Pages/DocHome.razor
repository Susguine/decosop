@page "/documents"
@using DecoSOP.Services
@using DecoSOP.Models
@inject DocumentService DocService
@inject UserPreferenceService Prefs
@inject DataCacheService Cache
@inject ContextMenuState MenuState
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Documents - DecoSOP</PageTitle>

<div class="home-container">
    <h1>Documents</h1>
    <p class="lead">Upload and organize office documents â€” forms, templates, and reference files. <span class="text-muted small">(@totalDocCount total)</span></p>

    @if (hasFavorites)
    {
        <div class="favorites-section">
            <h2>&#9733; Favorites</h2>
            <div class="category-grid">
                @foreach (var cat in favoriteCategories)
                {
                    <div class="category-card @(GetCatColor(cat.Id) is string c ? $"card-color-{c}" : "")"
                         @oncontextmenu="(e) => MenuState.Show(e.ClientX, e.ClientY, cat.Id, cat.Name, IsCatFavorited(cat.Id), IsCatPinned(cat.Id), GetCatColor(cat.Id), CategoryType.Document)"
                         @oncontextmenu:preventDefault="true">
                        <h3>
                            <FolderIcon Color="@GetCatColor(cat.Id)" />
                            <a href="documents/category/@cat.Id" class="category-heading-link">@cat.Name</a>
                            @if (IsCatPinned(cat.Id)) { <span class="pin-icon" title="Pinned">&#128204;</span> }
                            <button class="btn-star starred" title="Remove from favorites"
                                    @onclick="() => ToggleCategoryFavorite(cat)">&#9733;</button>
                        </h3>
                    </div>
                }
                @foreach (var doc in favoriteDocuments)
                {
                    <div class="category-card category-card-doc"
                         @oncontextmenu="(e) => MenuState.Show(e.ClientX, e.ClientY, doc.Id, doc.Title, IsDocFavorited(doc.Id), false, null, CategoryType.Document, ItemKind.Document)"
                         @oncontextmenu:preventDefault="true">
                        <h3>
                            <a href="documents/@doc.Id" class="category-heading-link">@doc.Title</a>
                            <span class="file-type-badge badge-@DocumentService.GetFileExtension(doc.FileName).ToLower()">@DocumentService.GetFileExtension(doc.FileName)</span>
                            <button class="btn-star starred" title="Remove from favorites"
                                    @onclick="() => ToggleDocumentFavorite(doc)">&#9733;</button>
                        </h3>
                        <span class="text-muted small">@doc.Category.Name &middot; @DocumentService.FormatFileSize(doc.FileSize)</span>
                    </div>
                }
            </div>
        </div>
    }

    @if (categories is null)
    {
        <SkeletonCards />
    }
    else
    {
        <div class="category-grid">
            @foreach (var category in categories.OrderByDescending(c => IsCatPinned(c.Id)).ThenBy(c => c.Name))
            {
                var totalCount = GetTotalDocCount(category);
                <div class="category-card @(GetCatColor(category.Id) is string c ? $"card-color-{c}" : "")"
                     @oncontextmenu="(e) => MenuState.Show(e.ClientX, e.ClientY, category.Id, category.Name, IsCatFavorited(category.Id), IsCatPinned(category.Id), GetCatColor(category.Id), CategoryType.Document)"
                     @oncontextmenu:preventDefault="true">
                    <h3>
                        <FolderIcon Color="@GetCatColor(category.Id)" />
                        <a href="documents/category/@category.Id" class="category-heading-link">@category.Name</a>
                        <span class="text-muted small">(@totalCount)</span>
                        @if (IsCatPinned(category.Id)) { <span class="pin-icon" title="Pinned">&#128204;</span> }
                        <button class="btn-star @(IsCatFavorited(category.Id) ? "starred" : "")"
                                title="@(IsCatFavorited(category.Id) ? "Remove from favorites" : "Add to favorites")"
                                @onclick="() => ToggleCategoryFavorite(category)">
                            @(IsCatFavorited(category.Id) ? "\u2605" : "\u2606")
                        </button>
                    </h3>
                    @if (category.Children.Any())
                    {
                        <p class="text-muted small" style="margin:0 0 0.25rem 0;">@category.Children.Count subfolder@(category.Children.Count != 1 ? "s" : "")</p>
                    }
                    @if (category.Documents.Any())
                    {
                        <ul class="card-doc-list">
                            @foreach (var doc in category.Documents.OrderBy(d => d.SortOrder))
                            {
                                <li @oncontextmenu="(e) => MenuState.Show(e.ClientX, e.ClientY, doc.Id, doc.Title, IsDocFavorited(doc.Id), false, null, CategoryType.Document, ItemKind.Document)"
                                    @oncontextmenu:preventDefault="true"
                                    @oncontextmenu:stopPropagation="true">
                                    <a href="documents/@doc.Id">@doc.Title</a>
                                    <span class="file-type-badge badge-@DocumentService.GetFileExtension(doc.FileName).ToLower()">@DocumentService.GetFileExtension(doc.FileName)</span>
                                </li>
                            }
                        </ul>
                    }
                    @if (totalCount == 0)
                    {
                        <p class="text-muted small" style="margin:0;">Empty</p>
                    }
                </div>
            }

            <div class="new-folder-card" @onclick="CreateFolder">
                <span>+ New Folder</span>
            </div>
        </div>
    }
</div>

@code {
    private CancellationTokenSource _cts = new();
    private List<DocumentCategory>? categories;
    private List<DocumentCategory> favoriteCategories = [];
    private List<OfficeDocument> favoriteDocuments = [];
    private Dictionary<int, UserPreference> catPrefs = new();
    private Dictionary<int, UserPreference> docPrefs = new();
    private bool hasFavorites => favoriteCategories.Count > 0 || favoriteDocuments.Count > 0;
    private int totalDocCount => categories?.Sum(c => GetTotalDocCount(c)) ?? 0;

    private bool IsCatFavorited(int id) => catPrefs.TryGetValue(id, out var p) && p.IsFavorited;
    private bool IsCatPinned(int id) => catPrefs.TryGetValue(id, out var p) && p.IsPinned;
    private string? GetCatColor(int id) => catPrefs.TryGetValue(id, out var p) ? p.Color : null;
    private bool IsDocFavorited(int id) => docPrefs.TryGetValue(id, out var p) && p.IsFavorited;

    protected override void OnInitialized()
    {
        MenuState.OnCategoryModified += RefreshData;
        MenuState.OnChange += StateHasChanged;
    }

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            _ = LoadDataAsync();
        return Task.CompletedTask;
    }

    private async Task LoadDataAsync()
    {
        try
        {
            await Task.Run(async () =>
            {
                categories = await Cache.GetDocTreeAsync();
                favoriteCategories = await Cache.GetDocFavoriteCategoriesAsync();
                favoriteDocuments = await Cache.GetDocFavoriteDocumentsAsync();
                catPrefs = await Cache.GetDocCategoryPrefsAsync();
                docPrefs = await Cache.GetDocDocPrefsAsync();
            }, _cts.Token);
            StateHasChanged();
        }
        catch (ObjectDisposedException) { }
        catch (OperationCanceledException) { }
    }

    private async Task RefreshData()
    {
        try
        {
            await Task.Run(async () =>
            {
                categories = await Cache.GetDocTreeAsync();
                favoriteCategories = await Cache.GetDocFavoriteCategoriesAsync();
                favoriteDocuments = await Cache.GetDocFavoriteDocumentsAsync();
                catPrefs = await Cache.GetDocCategoryPrefsAsync();
                docPrefs = await Cache.GetDocDocPrefsAsync();
            }, _cts.Token);
            await InvokeAsync(StateHasChanged);
        }
        catch (ObjectDisposedException) { }
        catch (OperationCanceledException) { }
    }

    public void Dispose()
    {
        _cts.Cancel();
        _cts.Dispose();
        MenuState.OnCategoryModified -= RefreshData;
        MenuState.OnChange -= StateHasChanged;
    }

    private async Task ToggleCategoryFavorite(DocumentCategory cat)
    {
        await Cache.RunExclusiveAsync(() => Prefs.ToggleFavoriteAsync(nameof(DocumentCategory), cat.Id));
        Cache.InvalidateDocFavorites();
        favoriteCategories = await Cache.GetDocFavoriteCategoriesAsync();
        favoriteDocuments = await Cache.GetDocFavoriteDocumentsAsync();
        catPrefs = await Cache.GetDocCategoryPrefsAsync();
    }

    private async Task ToggleDocumentFavorite(OfficeDocument doc)
    {
        await Cache.RunExclusiveAsync(() => Prefs.ToggleFavoriteAsync(nameof(OfficeDocument), doc.Id));
        Cache.InvalidateDocFavorites();
        favoriteCategories = await Cache.GetDocFavoriteCategoriesAsync();
        favoriteDocuments = await Cache.GetDocFavoriteDocumentsAsync();
        docPrefs = await Cache.GetDocDocPrefsAsync();
    }

    private async Task CreateFolder()
    {
        var name = await JS.InvokeAsync<string?>("prompt", "New folder name:");
        if (string.IsNullOrWhiteSpace(name)) return;
        if (name.Trim().Length > 200)
        {
            await JS.InvokeVoidAsync("alert", "Name must be 200 characters or fewer.");
            return;
        }

        await Cache.RunExclusiveAsync(() => DocService.CreateCategoryAsync(name));
        Cache.InvalidateAll();
        await RefreshData();
        await MenuState.NotifyCategoryModified();
    }

    private int GetTotalDocCount(DocumentCategory cat)
    {
        int count = cat.Documents.Count;
        foreach (var child in cat.Children)
            count += GetTotalDocCount(child);
        return count;
    }
}
