@page "/sops/category/{Id:int}"
@using DecoSOP.Services
@using DecoSOP.Models
@inject SopFileService SopFileService
@inject UserPreferenceService Prefs
@inject DataCacheService Cache
@inject NavigationManager Nav
@inject ContextMenuState MenuState
@inject IJSRuntime JS
@implements IDisposable

<div data-mode="sop"></div>
<PageTitle>@(category?.Name ?? "Category") - SOPs - DecoSOP</PageTitle>

@if (category is null)
{
    <div class="home-container">
        <div class="skeleton-line skeleton-title" style="width:30%; height:28px; margin-bottom:1rem;"></div>
        <SkeletonCards Count="6" />
    </div>
}
else
{
    <div class="home-container">
        <nav class="breadcrumb-nav" aria-label="breadcrumb">
            <a href="/sops">SOPs</a>
            @foreach (var crumb in breadcrumbs)
            {
                <span> / </span>
                @if (crumb.Id == category.Id)
                {
                    <span>@crumb.Name</span>
                }
                else
                {
                    <a href="sops/category/@crumb.Id">@crumb.Name</a>
                }
            }
        </nav>

        <div class="sop-toolbar" style="border-bottom:none; padding-bottom:0; margin-bottom:0.5rem;">
            <button class="btn btn-sm btn-outline-secondary me-2" @onclick="GoBack" title="Back">&larr; Back</button>
            <h1 style="margin:0;">@category.Name</h1>
            <div class="sop-actions">
                <a class="btn btn-sm btn-success" href="sops/upload?categoryId=@category.Id">Upload SOP</a>
            </div>
        </div>

        <div class="category-grid">
                @foreach (var child in category.Children.OrderByDescending(c => IsCatPinned(c.Id)).ThenBy(c => c.Name))
                {
                    var childTotal = GetTotalDocCount(child);
                    <div class="category-card @(GetCatColor(child.Id) is string c ? $"card-color-{c}" : "")"
                         @oncontextmenu="(e) => MenuState.Show(e.ClientX, e.ClientY, child.Id, child.Name, IsCatFavorited(child.Id), IsCatPinned(child.Id), GetCatColor(child.Id), CategoryType.Sop)"
                         @oncontextmenu:preventDefault="true">
                        <h3>
                            <FolderIcon Color="@GetCatColor(child.Id)" />
                            <a href="sops/category/@child.Id" class="category-heading-link">@child.Name</a>
                            <span class="text-muted small">(@childTotal)</span>
                            @if (IsCatPinned(child.Id)) { <span class="pin-icon" title="Pinned">&#128204;</span> }
                            <button class="btn-star @(IsCatFavorited(child.Id) ? "starred" : "")"
                                    title="@(IsCatFavorited(child.Id) ? "Remove from favorites" : "Add to favorites")"
                                    @onclick="() => ToggleCategoryFavorite(child)">
                                @(IsCatFavorited(child.Id) ? "\u2605" : "\u2606")
                            </button>
                        </h3>
                        @if (child.Children.Any())
                        {
                            <p class="text-muted small" style="margin:0 0 0.25rem 0;">@child.Children.Count subfolder@(child.Children.Count != 1 ? "s" : "")</p>
                        }
                        @if (child.Documents.Any())
                        {
                            <ul class="card-doc-list">
                                @foreach (var doc in child.Documents.OrderBy(d => d.SortOrder))
                                {
                                    <li @oncontextmenu="(e) => MenuState.Show(e.ClientX, e.ClientY, doc.Id, doc.Title, IsDocFavorited(doc.Id), false, null, CategoryType.Sop, ItemKind.Document)"
                                        @oncontextmenu:preventDefault="true"
                                        @oncontextmenu:stopPropagation="true">
                                        <a href="sops/@doc.Id">@doc.Title</a>
                                        <span class="file-type-badge badge-@SopFileService.GetFileExtension(doc.FileName).ToLower()">@SopFileService.GetFileExtension(doc.FileName)</span>
                                    </li>
                                }
                            </ul>
                        }
                    </div>
                }

                @foreach (var doc in category.Documents.OrderBy(d => d.SortOrder))
                {
                    <div class="category-card category-card-doc"
                         @oncontextmenu="(e) => MenuState.Show(e.ClientX, e.ClientY, doc.Id, doc.Title, IsDocFavorited(doc.Id), false, null, CategoryType.Sop, ItemKind.Document)"
                         @oncontextmenu:preventDefault="true">
                        <h3>
                            <a href="sops/@doc.Id" class="category-heading-link">@doc.Title</a>
                            <span class="file-type-badge badge-@SopFileService.GetFileExtension(doc.FileName).ToLower()">@SopFileService.GetFileExtension(doc.FileName)</span>
                            <button class="btn-star @(IsDocFavorited(doc.Id) ? "starred" : "")"
                                    title="@(IsDocFavorited(doc.Id) ? "Remove from favorites" : "Add to favorites")"
                                    @onclick="() => ToggleDocumentFavorite(doc)">
                                @(IsDocFavorited(doc.Id) ? "\u2605" : "\u2606")
                            </button>
                        </h3>
                        <span class="text-muted small">@SopFileService.FormatFileSize(doc.FileSize)</span>
                    </div>
                }
                <div class="new-folder-card" @onclick="CreateSubfolder">
                    <span>+ New Subfolder</span>
                </div>
            </div>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }

    private CancellationTokenSource _cts = new();
    private SopCategory? category;
    private List<(int Id, string Name)> breadcrumbs = [];
    private bool _needsLoad;

    private Dictionary<int, UserPreference> catPrefs = new();
    private Dictionary<int, UserPreference> docPrefs = new();
    private bool IsCatFavorited(int id) => catPrefs.TryGetValue(id, out var p) && p.IsFavorited;
    private bool IsCatPinned(int id) => catPrefs.TryGetValue(id, out var p) && p.IsPinned;
    private string? GetCatColor(int id) => catPrefs.TryGetValue(id, out var p) ? p.Color : null;
    private bool IsDocFavorited(int id) => docPrefs.TryGetValue(id, out var p) && p.IsFavorited;

    protected override void OnInitialized()
    {
        MenuState.OnCategoryModified += RefreshData;
        MenuState.OnChange += StateHasChanged;
    }

    protected override void OnParametersSet()
    {
        category = null;
        _needsLoad = true;
    }

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (_needsLoad)
        {
            _needsLoad = false;
            _ = LoadDataAsync();
        }
        return Task.CompletedTask;
    }

    private async Task LoadDataAsync()
    {
        try
        {
            await Task.Run(async () =>
            {
                category = await Cache.FindSopCategoryAsync(Id);
                if (category is not null)
                    breadcrumbs = await Cache.GetSopBreadcrumbsAsync(Id);
                catPrefs = await Cache.GetSopCategoryPrefsAsync();
                docPrefs = await Cache.GetSopFilePrefsAsync();
            }, _cts.Token);
            StateHasChanged();
        }
        catch (ObjectDisposedException) { }
        catch (OperationCanceledException) { }
    }

    private async Task RefreshData()
    {
        try
        {
            await Task.Run(async () =>
            {
                category = await Cache.FindSopCategoryAsync(Id);
                if (category is not null)
                    breadcrumbs = await Cache.GetSopBreadcrumbsAsync(Id);
                catPrefs = await Cache.GetSopCategoryPrefsAsync();
                docPrefs = await Cache.GetSopFilePrefsAsync();
            }, _cts.Token);
            await InvokeAsync(StateHasChanged);
        }
        catch (ObjectDisposedException) { }
        catch (OperationCanceledException) { }
    }

    public void Dispose()
    {
        _cts.Cancel();
        _cts.Dispose();
        MenuState.OnCategoryModified -= RefreshData;
        MenuState.OnChange -= StateHasChanged;
    }

    private async Task ToggleCategoryFavorite(SopCategory cat)
    {
        await Cache.RunExclusiveAsync(() => Prefs.ToggleFavoriteAsync(nameof(SopCategory), cat.Id));
        catPrefs = await Cache.GetSopCategoryPrefsAsync();
    }

    private async Task ToggleDocumentFavorite(SopFile doc)
    {
        await Cache.RunExclusiveAsync(() => Prefs.ToggleFavoriteAsync(nameof(SopFile), doc.Id));
        docPrefs = await Cache.GetSopFilePrefsAsync();
    }

    private async Task CreateSubfolder()
    {
        var name = await JS.InvokeAsync<string?>("prompt", "New subfolder name:");
        if (string.IsNullOrWhiteSpace(name)) return;
        if (name.Trim().Length > 200)
        {
            await JS.InvokeVoidAsync("alert", "Name must be 200 characters or fewer.");
            return;
        }

        await Cache.RunExclusiveAsync(() => SopFileService.CreateCategoryAsync(name, Id));
        Cache.InvalidateAll();
        await RefreshData();
        await MenuState.NotifyCategoryModified();
    }

    private void GoBack()
    {
        if (breadcrumbs.Count >= 2)
            Nav.NavigateTo($"sops/category/{breadcrumbs[^2].Id}");
        else
            Nav.NavigateTo("sops");
    }

    private int GetTotalDocCount(SopCategory cat)
    {
        int count = cat.Documents.Count;
        foreach (var child in cat.Children)
            count += GetTotalDocCount(child);
        return count;
    }
}
