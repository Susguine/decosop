@page "/webdocs/{Id:int}/edit"
@page "/webdocs/new"
@using DecoSOP.Services
@using DecoSOP.Models
@inject WebDocService WebDocService
@inject NavigationManager Nav
@inject IJSRuntime JS
@implements IAsyncDisposable

<PageTitle>@(isNew ? "New Web Doc" : $"Edit: {title}") - DecoSOP</PageTitle>

<div class="sop-editor">
    <div class="sop-toolbar">
        <input type="text" class="form-control form-control-lg sop-title-input"
               placeholder="Document Title" @bind="title" />
        <div class="sop-actions">
            <button class="btn btn-sm btn-success" @onclick="Save" disabled="@isSaving">
                @(isSaving ? "Saving..." : "Save")
            </button>
            <button class="btn btn-sm btn-secondary" @onclick="Cancel">Cancel</button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(error))
    {
        <div class="alert alert-danger mt-2">@error</div>
    }

    @if (isNew)
    {
        <div class="mb-3">
            <label class="form-label">Category</label>
            <select class="form-select form-select-sm" style="max-width: 500px;" @bind="selectedCategoryId">
                @if (categoryOptions is not null)
                {
                    @foreach (var opt in categoryOptions)
                    {
                        <option value="@opt.Id">@opt.Path</option>
                    }
                }
            </select>
        </div>
    }

    <div class="editor-wrapper">
        <textarea id="jodit-editor"></textarea>
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }
    [SupplyParameterFromQuery] public int? CategoryId { get; set; }

    private string title = string.Empty;
    private string initialHtml = string.Empty;
    private string error = string.Empty;
    private bool isSaving;
    private bool isNew => Id == 0;
    private bool editorInitialized;
    private List<(int Id, string Path)>? categoryOptions;
    private int selectedCategoryId;

    protected override async Task OnParametersSetAsync()
    {
        if (isNew)
        {
            var allCats = await WebDocService.GetAllCategoriesAsync();
            var lookup = allCats.ToDictionary(c => c.Id);
            categoryOptions = allCats.Select(c =>
            {
                var parts = new List<string>();
                var cur = c;
                while (cur is not null)
                {
                    parts.Insert(0, cur.Name);
                    cur = cur.ParentId.HasValue && lookup.ContainsKey(cur.ParentId.Value) ? lookup[cur.ParentId.Value] : null;
                }
                return (c.Id, Path: string.Join(" / ", parts));
            }).OrderBy(x => x.Path).ToList();
            selectedCategoryId = CategoryId ?? categoryOptions?.FirstOrDefault().Id ?? 0;
            initialHtml = "";
        }
        else
        {
            var doc = await WebDocService.GetDocumentAsync(Id);
            if (doc is null)
            {
                Nav.NavigateTo("/webdocs");
                return;
            }
            title = doc.Title;
            initialHtml = doc.HtmlContent;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !editorInitialized)
        {
            editorInitialized = true;
            await JS.InvokeVoidAsync("editorInterop.create", "jodit-editor", initialHtml);
        }
    }

    private async Task Save()
    {
        error = string.Empty;

        if (string.IsNullOrWhiteSpace(title))
        {
            error = "Title is required.";
            return;
        }

        if (title.Trim().Length > 200)
        {
            error = "Title must be 200 characters or fewer.";
            return;
        }

        isSaving = true;

        try
        {
            var htmlContent = await JS.InvokeAsync<string>("editorInterop.getHtml");
            await JS.InvokeVoidAsync("editorInterop.clearDirty");

            if (isNew)
            {
                var doc = await WebDocService.CreateDocumentAsync(selectedCategoryId, title);
                await WebDocService.UpdateDocumentAsync(doc.Id, title, htmlContent);
                Nav.NavigateTo($"/webdocs/{doc.Id}");
            }
            else
            {
                await WebDocService.UpdateDocumentAsync(Id, title, htmlContent);
                Nav.NavigateTo($"/webdocs/{Id}");
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            isSaving = false;
        }
    }

    private void Cancel()
    {
        if (isNew)
            Nav.NavigateTo("/webdocs");
        else
            Nav.NavigateTo($"/webdocs/{Id}");
    }

    public async ValueTask DisposeAsync()
    {
        if (editorInitialized)
        {
            try
            {
                await JS.InvokeVoidAsync("editorInterop.dispose");
            }
            catch (JSDisconnectedException) { }
        }
    }
}
