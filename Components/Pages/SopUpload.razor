@page "/sops/upload"
@using DecoSOP.Services
@using DecoSOP.Models
@using Microsoft.AspNetCore.Components.Forms
@inject SopFileService SopFileService
@inject NavigationManager Nav

<div data-mode="sop"></div>
<PageTitle>Upload SOP - DecoSOP</PageTitle>

<div class="sop-editor">
    <div class="sop-toolbar">
        <h1 class="m-0" style="font-size:1.4rem;">Upload SOP</h1>
        <div class="sop-actions">
            <button class="btn btn-sm btn-success" @onclick="Upload" disabled="@(isUploading || selectedFile is null)">
                @(isUploading ? "Uploading..." : "Upload")
            </button>
            <button class="btn btn-sm btn-secondary" @onclick="Cancel">Cancel</button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(error))
    {
        <div class="alert alert-danger mt-2">@error</div>
    }

    <div class="mt-3">
        <div class="mb-3">
            <label class="form-label">Title</label>
            <input type="text" class="form-control" style="max-width:500px;" placeholder="SOP title"
                   @bind="title" />
        </div>

        <div class="mb-3">
            <label class="form-label">Category</label>
            <select class="form-select form-select-sm" style="max-width: 500px;" @bind="selectedCategoryId">
                @if (categoryOptions is not null)
                {
                    @foreach (var opt in categoryOptions)
                    {
                        <option value="@opt.Id">@opt.Path</option>
                    }
                }
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">File</label>
            <div class="upload-zone">
                <InputFile OnChange="OnFileSelected" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.png,.jpg,.jpeg,.gif,.zip" />
                @if (selectedFile is not null)
                {
                    <p class="mt-2 mb-0">
                        <strong>@selectedFile.Name</strong>
                        <span class="text-muted small">(@SopFileService.FormatFileSize(selectedFile.Size))</span>
                    </p>
                }
                else
                {
                    <p class="mt-2 mb-0 text-muted">Select a file to upload (max 50 MB)</p>
                }
            </div>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromQuery] public int? CategoryId { get; set; }

    private string title = string.Empty;
    private string error = string.Empty;
    private bool isUploading;
    private IBrowserFile? selectedFile;
    private List<(int Id, string Path)>? categoryOptions;
    private int selectedCategoryId;

    protected override async Task OnInitializedAsync()
    {
        var allCats = await SopFileService.GetAllCategoriesAsync();
        var lookup = allCats.ToDictionary(c => c.Id);
        categoryOptions = allCats.Select(c =>
        {
            var parts = new List<string>();
            var cur = c;
            while (cur is not null)
            {
                parts.Insert(0, cur.Name);
                cur = cur.ParentId.HasValue && lookup.ContainsKey(cur.ParentId.Value) ? lookup[cur.ParentId.Value] : null;
            }
            return (c.Id, Path: string.Join(" / ", parts));
        }).OrderBy(x => x.Path).ToList();

        selectedCategoryId = CategoryId ?? categoryOptions?.FirstOrDefault().Id ?? 0;
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        error = string.Empty;

        if (string.IsNullOrWhiteSpace(title))
        {
            title = Path.GetFileNameWithoutExtension(selectedFile.Name);
        }
    }

    private async Task Upload()
    {
        error = string.Empty;

        if (string.IsNullOrWhiteSpace(title))
        {
            error = "Title is required.";
            return;
        }

        if (selectedFile is null)
        {
            error = "Please select a file.";
            return;
        }

        if (selectedCategoryId == 0)
        {
            error = "Please select a category. Create one first if needed.";
            return;
        }

        isUploading = true;

        try
        {
            var doc = await SopFileService.UploadDocumentAsync(selectedCategoryId, title, selectedFile);
            Nav.NavigateTo($"/sops/{doc.Id}");
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            isUploading = false;
        }
    }

    private void Cancel() => Nav.NavigateTo("/sops");
}
