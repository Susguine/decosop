@using DecoSOP.Services
@using DecoSOP.Models
@inject SopService SopService
@inject NavigationManager Nav
@implements IDisposable

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="">DecoSOP</a>
    </div>
</div>

<div class="sidebar-content">
    <div class="sidebar-search px-3 py-2">
        <input type="text" class="form-control form-control-sm" placeholder="Search SOPs..."
               @bind="searchQuery" @bind:event="oninput" @onkeyup="OnSearchKeyUp" />
    </div>

    @if (isSearching)
    {
        <div class="nav-section px-3 py-1">
            <span class="nav-section-title">Search Results</span>
        </div>
        @foreach (var doc in searchResults)
        {
            <div class="nav-item px-3">
                <NavLink class="nav-link" href="@($"sop/{doc.Id}")">
                    @doc.Title
                    <span class="nav-category-hint">@doc.Category.Name</span>
                </NavLink>
            </div>
        }
        @if (searchResults.Count == 0)
        {
            <div class="px-3 py-2 text-muted small">No results found.</div>
        }
    }
    else
    {
        @if (hasFavorites)
        {
            <div class="nav-section px-3">
                <button class="nav-section-toggle" @onclick="() => favoritesExpanded = !favoritesExpanded">
                    <span class="toggle-icon">@(favoritesExpanded ? "▾" : "▸")</span>
                    <span class="nav-section-title">&#9733; Favorites</span>
                    <span class="nav-section-count">@(favoriteCategories.Count + favoriteDocuments.Count)</span>
                </button>
            </div>

            @if (favoritesExpanded)
            {
                @foreach (var cat in favoriteCategories)
                {
                    <div class="nav-item px-3">
                        <NavLink class="nav-link" href="@($"category/{cat.Id}")">
                            @cat.Name
                            <span class="nav-category-hint">folder</span>
                        </NavLink>
                    </div>
                }
                @foreach (var doc in favoriteDocuments)
                {
                    <div class="nav-item px-3">
                        <NavLink class="nav-link" href="@($"sop/{doc.Id}")">
                            @doc.Title
                            <span class="nav-category-hint">@doc.Category.Name</span>
                        </NavLink>
                    </div>
                }

                <hr class="sidebar-divider" />
            }
        }

        <nav class="nav flex-column">
            <div class="nav-item px-3">
                <NavLink class="nav-link" href="" Match="NavLinkMatch.All">
                    Home
                </NavLink>
            </div>

            @if (categories is not null)
            {
                @foreach (var category in categories.OrderBy(c => c.Name))
                {
                    @RenderCategoryTree(category, 0)
                }
            }
        </nav>
    }
</div>

@code {
    private List<Category>? categories;
    private List<Category> favoriteCategories = [];
    private List<SopDocument> favoriteDocuments = [];
    private HashSet<int> expandedCategories = [];
    private string searchQuery = string.Empty;
    private List<SopDocument> searchResults = [];
    private bool isSearching => !string.IsNullOrWhiteSpace(searchQuery);
    private bool hasFavorites => favoriteCategories.Count > 0 || favoriteDocuments.Count > 0;
    private bool favoritesExpanded = true;
    private System.Timers.Timer? debounceTimer;

    protected override async Task OnInitializedAsync()
    {
        Nav.LocationChanged += OnLocationChanged;
        await LoadCategories();
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        await InvokeAsync(async () =>
        {
            await LoadCategories();
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
    }

    public async Task LoadCategories()
    {
        categories = await SopService.GetCategoryTreeAsync();
        favoriteCategories = await SopService.GetFavoriteCategoriesAsync();
        favoriteDocuments = await SopService.GetFavoriteDocumentsAsync();
        StateHasChanged();
    }

    private bool IsExpanded(int categoryId) => expandedCategories.Contains(categoryId);

    private void ToggleCategory(int categoryId)
    {
        if (!expandedCategories.Remove(categoryId))
            expandedCategories.Add(categoryId);
    }

    private int GetTotalDocCount(Category cat)
    {
        int count = cat.Documents.Count;
        foreach (var child in cat.Children)
            count += GetTotalDocCount(child);
        return count;
    }

    private RenderFragment RenderCategoryTree(Category category, int depth) => __builder =>
    {
        var paddingLeft = $"{1 + depth * 0.75}rem";
        var docPaddingLeft = $"{1.75 + depth * 0.75}rem";
        var totalCount = GetTotalDocCount(category);

        <div class="nav-section" style="padding-left: @paddingLeft;">
            <button class="nav-section-toggle" @onclick="() => ToggleCategory(category.Id)">
                <span class="toggle-icon">@(IsExpanded(category.Id) ? "▾" : "▸")</span>
                <span class="nav-section-title">@category.Name</span>
                <span class="nav-section-count">@totalCount</span>
            </button>
        </div>

        @if (IsExpanded(category.Id))
        {
            @foreach (var child in category.Children.OrderBy(c => c.Name))
            {
                @RenderCategoryTree(child, depth + 1)
            }

            @foreach (var doc in category.Documents)
            {
                <div class="nav-item" style="padding-left: @docPaddingLeft;">
                    <NavLink class="nav-link" href="@($"sop/{doc.Id}")">
                        @doc.Title
                    </NavLink>
                </div>
            }

            <div class="nav-item" style="padding-left: @docPaddingLeft;">
                <NavLink class="nav-link nav-link-new" href="@($"sop/new?categoryId={category.Id}")">
                    + New SOP
                </NavLink>
            </div>
        }
    };

    private async Task OnSearchKeyUp()
    {
        debounceTimer?.Stop();
        debounceTimer?.Dispose();

        if (string.IsNullOrWhiteSpace(searchQuery))
        {
            searchResults = [];
            return;
        }

        debounceTimer = new System.Timers.Timer(300);
        debounceTimer.Elapsed += async (_, _) =>
        {
            debounceTimer?.Stop();
            await InvokeAsync(async () =>
            {
                searchResults = await SopService.SearchAsync(searchQuery);
                StateHasChanged();
            });
        };
        debounceTimer.AutoReset = false;
        debounceTimer.Start();
    }
}
